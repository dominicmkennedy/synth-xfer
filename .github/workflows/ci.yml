name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  ci:
    name: Format, lint, typecheck, test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            CMakeLists.txt
            cpp/**

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install dependencies and build
        run: |
          echo "=== Installing dependencies (and building C++ eval engine) ==="
          pip install ".[dev]" ruff pyright

      - name: Formatting check (pre-commit: ruff-format)
        run: |
          echo "=== Step 1/4: Formatting check with ruff-format (pre-commit) ==="
          pre-commit run ruff-format --all-files

      - name: Linting (pre-commit: ruff)
        run: |
          echo "=== Step 2/4: Linting with ruff (pre-commit) ==="
          pre-commit run ruff --all-files

      - name: Type checking (pyright)
        run: |
          echo "=== Step 3/4: Type checking with pyright ==="
          pyright

      - name: Tests (pytest)
        run: |
          echo "=== Step 4/4: Running tests with pytest ==="
          pytest -vv
